<section id="edit_post_modal"
    style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center;"
    onclick="closeEditModalOnBackdrop(event)">
    <div style="background: white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; margin: 1rem;"
        onclick="event.stopPropagation()">

        <!-- header -->
        <div
            style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
            <header>
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #111827; margin: 0;">{{
                    x.lans('edit_post')}}</h3>
            </header>
            <button type="button" onclick="closeEditModal()"
                style="color: #9ca3af; background: transparent; border: none; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; line-height: 1; cursor: pointer; transition: all 0.2s;">
                &times;
            </button>
        </div>

        <!-- Body -->
        <div style="flex: 1; overflow-y: auto; padding: 1rem 1.5rem;">
            <form id="edit_post_form" class="p-6">
                <input type="hidden" id="edit_post_pk" name="post_pk">

                <textarea name="post" id="edit_post_message"
                    class="w-full border-2 border-black rounded-lg p-3 mb-4 focus:border-blue-500 focus:outline-none resize-none transition-colors"
                    rows="4" placeholder="{{ x.lans('what_is_happening') }}"
                    style="font-size: 16px; padding: 10px 14px 10px 16px; border: 2px solid black;"></textarea>

                <!-- current image displayer -->
                <div id="edit_current_image_section" class="mb-4 p-4 bg-gray-50 rounded-lg"
                    style="display: none; transition: opacity 0.3s;">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">{{
                        x.lans('edit_current_image')}}</label>
                    <div class="relative inline-block">
                        <img id="edit_current_image" src="" alt="Current post image"
                            class="max-w-full h-auto rounded-lg border-2 border-gray-200" style="max-height: 300px;">
                    </div>
                    <div class="mt-3">
                        <label
                            class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer hover:text-red-600 transition-colors">
                            <input type="checkbox" name="remove_image" id="edit_remove_image" value="1"
                                onchange="toggleRemoveImage()"
                                class="w-4 h-4 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                            <span class="font-medium">{{
                                x.lans('remove_image')}}</span>
                        </label>
                    </div>
                </div>

                <!-- a new image upload ui -->
                <div class="mb-4">
                    <button type="button" onclick="triggerFileInput()"
                        class="cursor-pointer inline-flex items-center gap-2 px-5 py-2.5 bg-blue-500 text-white font-medium hover:bg-blue-600 rounded-lg transition-all shadow-sm hover:shadow">
                        <i class="fa-regular fa-image"></i>
                        <span id="edit_image_button_text">{{
                            x.lans('add_image')}}</span>
                    </button>
                    <input type="file" id="edit_file_input" name="post_file" accept="image/*" class="hidden"
                        onchange="handleFileChange()">
                </div>

                <!-- new image previewr -->
                <div id="edit_preview_section" class="mb-4 p-4 bg-blue-50 rounded-lg"
                    style="display: none; animation: fadeIn 0.3s;">
                    <div class="relative inline-block">
                        <img id="edit_preview_img" src="" alt="Preview"
                            class="max-w-full h-auto rounded-lg border-2 border-blue-200" style="max-height: 300px;">
                        <button type="button" onclick="removeNewImagePreview()"
                            class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-all hover:scale-110"
                            style="font-size: 20px; line-height: 1;">X</button>
                    </div>
                </div>

                <!-- footer -->
                <div class="flex gap-3 justify-end pt-4 border-t border-gray-200 mt-6">
                    <button type="button" onclick="closeEditModal()" class="px-5 py-2.5 cancel-btn">
                        {{
                        x.lans('cancel')}}
                    </button>
                    <button type="submit" class="px-5 py-2.5 post-content-btn">
                        {{
                        x.lans('save_changes')}}
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
    // Global variable to track current editing post
    let currentEditingPostPk = null;

    function openEditModal(postPk, postMessage, postImagePath) {
        currentEditingPostPk = postPk;

        // Set form values
        document.getElementById('edit_post_pk').value = postPk;
        document.getElementById('edit_post_message').value = postMessage;

        // Handle current image
        const currentImageSection = document.getElementById('edit_current_image_section');
        const currentImage = document.getElementById('edit_current_image');
        const imageButtonText = document.getElementById('edit_image_button_text');

        if (postImagePath) {
            currentImage.src = `/static/images/${postImagePath}`;
            currentImageSection.style.display = 'block';
        } else {
            currentImageSection.style.display = 'none';
        }

        // Reset form state
        document.getElementById('edit_remove_image').checked = false;
        document.getElementById('edit_file_input').value = '';
        document.getElementById('edit_preview_section').style.display = 'none';
        currentImageSection.style.opacity = '1';

        // Show modal
        const modal = document.getElementById('edit_post_modal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        const modal = document.getElementById('edit_post_modal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        currentEditingPostPk = null;
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' || event.key === 'Esc') {
            const modal = document.getElementById('edit_post_modal');
            if (modal && modal.style.display === 'flex') {
                closeEditModal();
            }
        }
    });

    function closeEditModalOnBackdrop(event) {
        if (event.target.id === 'edit_post_modal') {
            closeEditModal();
        }
    }

    function triggerFileInput() {
        document.getElementById('edit_file_input').click();
    }

    function handleFileChange() {
        const fileInput = document.getElementById('edit_file_input');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                document.getElementById('edit_preview_img').src = event.target.result;
                document.getElementById('edit_preview_section').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function removeNewImagePreview() {
        document.getElementById('edit_file_input').value = '';
        document.getElementById('edit_preview_section').style.display = 'none';
    }

    function toggleRemoveImage() {
        const checkbox = document.getElementById('edit_remove_image');
        const currentImageSection = document.getElementById('edit_current_image_section');

        if (checkbox.checked) {
            currentImageSection.style.opacity = '0.5';
        } else {
            currentImageSection.style.opacity = '1';
        }
    }

    // Form submission
    document.getElementById('edit_post_form').onsubmit = function (e) {
        e.preventDefault();

        if (!currentEditingPostPk) return;

        const formData = new FormData(e.target);

        fetch(`/api-update-post/${currentEditingPostPk}`, {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
            .then(res => res.text())
            .then(html => {
                closeEditModal();
                document.body.insertAdjacentHTML('beforeend', html);
                if (typeof mixhtml === 'function') {
                    mixhtml(html, `/api-update-post/${currentEditingPostPk}`);
                }
            })
    };
</script>