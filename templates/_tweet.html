<article class="post" mix-fade-in="5000" id="post_{{ tweet.post_pk }}">
    <img src="{{ url_for('static', filename='images/'~(tweet.user_avatar_path if tweet.user_avatar_path else 'unknown.jpg')) }}"
        alt="Profile Picture" class="w-8 h-8 rounded-full">
    <div class="post-content">
        <div class="post-header">
            <span class="name">
                {{ tweet.user_first_name }}
                {{ tweet.user_last_name }}
            </span>
            <span class="handle">@{{ tweet.user_username }}</span> Â·
            <span class="time">
                {% if tweet.post_created_at %}
                {{ tweet.post_created_at.strftime('%b %d, %Y at %I:%M %p') }}
                {% else %}
                Recently
                {% endif %}
            </span>

            <!-- Show edit/delete buttons only if user owns the post -->
            {% if user and user.user_pk == tweet.post_user_fk %}
            <div class="ml-auto flex gap-2">
                <button onclick="editPost('{{ tweet.post_pk }}')" class="text-blue-500 hover:text-blue-700">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button onclick="deletePost('{{ tweet.post_pk }}')" class="text-red-500 hover:text-red-700">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            {% endif %}
        </div>

        <p class="text" id="post_text_{{ tweet.post_pk }}">
            {{ tweet.post_message }}
        </p>

        {% if tweet.post_image_path: %}
        <img src="{{ url_for('static', filename='images/' ~ tweet.post_image_path) }}" alt="Post image"
            id="post_image_{{ tweet.post_pk }}" class="w-80">
        {% endif %}

        <div class="post-actions">
            <span class="action"><i class="fa-regular fa-comment"></i> 12</span>
            <span class="action"><i class="fa-solid fa-retweet"></i> 5</span>
            {% include "___button_like_tweet.html" %}
            <span class="action"><i class="fa-solid fa-chart-simple"></i> 230</span>
            <span class="action"><i class="fa-solid fa-share"></i></span>
        </div>
    </div>
</article>

<script>
    function deletePost(postPk) {
        if (!confirm('Are you sure you want to delete this post?')) return;

        fetch(`/api-delete-post/${postPk}`, {
            method: 'DELETE'
        })
            .then(response => response.text())
            .then(html => {
                document.body.insertAdjacentHTML('beforeend', html);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete post');
            });
    }

    function editPost(postPk) {
        const postElement = document.getElementById(`post_${postPk}`);
        const textElement = document.getElementById(`post_text_${postPk}`);
        const imageElement = document.getElementById(`post_image_${postPk}`);

        const currentText = textElement.textContent.trim();
        const hasImage = imageElement !== null;

        // Create edit form
        const editForm = `
        <form id="edit_form_${postPk}" class="mt-2" onsubmit="saveEdit(event, '${postPk}')">
            <textarea name="post" class="w-full outline-1 outline-s-solid outline-c-gray:+50 pa-2" rows="3">${currentText}</textarea>
            
            ${hasImage ? `
                <div class="mt-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="remove_image" value="1"> Remove current image
                    </label>
                </div>
            ` : ''}
            
            <input type="file" id="edit_file_${postPk}" name="post_file" accept="image/*" style="display: none;">
            
            <div id="edit_preview_${postPk}" class="mt-2" style="display: none;">
                <div class="relative inline-block">
                    <img id="edit_preview_img_${postPk}" src="" alt="Preview" class="w-32 h-32 object-cover rounded-lg border">
                    <button type="button" onclick="removeEditImage('${postPk}')"
                        class="absolute -top-2 -right-2 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg">
                        X
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2 mt-2">
                <button type="button" onclick="document.getElementById('edit_file_${postPk}').click()" class="p-2 rounded-full">
                    <i class="fa-regular fa-image"></i>
                </button>
                <button type="submit" class="post-content-btn">Save</button>
                <button type="button" onclick="cancelEdit('${postPk}')" class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
            </div>
        </form>
    `;

        textElement.innerHTML = editForm;
        if (imageElement) imageElement.style.display = 'none';

        // Setup image preview for edit
        document.getElementById(`edit_file_${postPk}`).addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    document.getElementById(`edit_preview_img_${postPk}`).src = event.target.result;
                    document.getElementById(`edit_preview_${postPk}`).style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function removeEditImage(postPk) {
        document.getElementById(`edit_file_${postPk}`).value = '';
        document.getElementById(`edit_preview_${postPk}`).style.display = 'none';
    }

    function cancelEdit(postPk) {
        location.reload(); // Simple solution - reload the page
    }

    function saveEdit(event, postPk) {
        event.preventDefault();
        const formData = new FormData(event.target);

        fetch(`/api-update-post/${postPk}`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.text())
            .then(html => {
                document.body.insertAdjacentHTML('beforeend', html);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update post');
            });
    }
</script>